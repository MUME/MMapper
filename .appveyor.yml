version: 1.0.{build}

branches:
  only:
    - master

clone_folder: c:\Build\MMapper

environment:
  matrix:
  - ARCH: x86
    COMPILER: MinGW
    QTDIR: C:\Qt\5.12\mingw73_32
    MINGWDIR: C:\mingw-w64\i686-8.1.0-posix-seh-rt_v6-rev0\mingw32

  - ARCH: x64
    COMPILER: MinGW
    QTDIR: C:\Qt\5.12\mingw73_64
    MINGWDIR: C:\mingw-w64\x86_64-8.1.0-posix-seh-rt_v6-rev0\mingw64

  - ARCH: x86
    COMPILER: VS2017
    QTDIR: C:\Qt\5.12\msvc2017

  - ARCH: x64
    COMPILER: VS2017
    QTDIR: C:\Qt\5.12\msvc2017_64

image: Visual Studio 2017

init:
  - set VCARCH=%ARCH%
  - if %ARCH%==x64 set VCARCH=amd64
  - if %COMPILER%==VS2017 (
      call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvarsall.bat" %VCARCH%
    )
  - if %COMPILER%==MinGW (
      set CMAKE_GENERATOR="MinGW Makefiles"
    ) else (
      set CMAKE_GENERATOR="NMake Makefiles JOM"
    )
  - git config --global core.autocrlf input
  - echo NUMBER_OF_PROCESSORS=%NUMBER_OF_PROCESSORS%
  - echo PROCESSOR_IDENTIFIER=%PROCESSOR_IDENTIFIER%
  - echo QTDIR=%QTDIR%
  - echo CMAKE_GENERATOR=%CMAKE_GENERATOR%

install:
  - ps: $env:package_version = ("$(git describe --tags --always --long)").trim()
  - ps: Update-AppveyorBuild -Version "$env:package_version-$env:APPVEYOR_BUILD_NUMBER"
  - if %COMPILER%==MinGW if %ARCH%==x86 if not exist "C:\mingw-w64\i686-8.1.0-posix-seh-rt_v6-rev0" md C:\mingw-w64\i686-8.1.0-posix-seh-rt_v6-rev0
  - if %COMPILER%==MinGW if %ARCH%==x86 cd C:\mingw-w64\i686-8.1.0-posix-seh-rt_v6-rev0
  - if %COMPILER%==MinGW if %ARCH%==x86 dir
  - if %COMPILER%==MinGW if %ARCH%==x86 if not exist "mingw32" appveyor-retry appveyor DownloadFile "http://downloads.sourceforge.net/mingw-w64/i686-8.1.0-release-posix-dwarf-rt_v6-rev0.7z" -FileName "mingw32.7z"
  - if %COMPILER%==MinGW if %ARCH%==x86 if exist "mingw32.7z" 7z x -y "mingw32.7z" > nul

cache:
  - C:\mingw-w64\i686-8.1.0-posix-seh-rt_v6-rev0\mingw32

before_build:
  - set PATH=%QTDIR%\bin;C:\Qt\Tools\QtCreator\bin;%PATH%
  - if %COMPILER%==MinGW set PATH=%MINGWDIR%\bin;%PATH:C:\Program Files\Git\usr\bin;=%
  - echo PATH=%PATH%
 
build:

build_script:
  - cd c:\Build\MMapper
  - md winbuild
  - cd winbuild
  - cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo -G %CMAKE_GENERATOR% "-DCMAKE_PREFIX_PATH=%QTDIR%"
  - cmake --build . -j %NUMBER_OF_PROCESSORS%
  - cpack

test_script:
  - cmd: ctest -V

artifacts:
  - path: winbuild\mmapper-*-Windows-$(ARCH).exe
    name: MMapper Installer
  
  - path: winbuild\mmapper-*-Windows-$(ARCH).zip
    name: MMapper ZIP
